const { src, dest, series } = require('gulp');
const through2 = require('through2');
const del = require('delete');
const tap = require('gulp-tap');
const fse = require('fs-extra');

let memory = {};
memory.moduleMuiIconsContents = '';

function deleteIcons(cb) {
  del(['./src/*.re'], cb);
}

function loadBaseMuiIcon() {
  return src('./mui-icon/MUIIcon.re')
    .pipe(tap(function(file) {
      memory.baseMuiIcon = file.contents.toString();
    }));
}

function makeIcons() {
  return src('./node_modules/@material-ui/icons/*.js')
    .pipe(through2.obj(function(file, _, cb) {
      if (file.isBuffer()) {
        let iconName = file.basename.replace('.js', '');
        let contents =
          '/* This file generated by gulp */\n' + 
          memory.baseMuiIcon + '\n\n' +
          '[@bs.module "@material-ui/icons/' + iconName + '"]\n' +
          'external make: React.component(props) = "default";'; 
        file.stem = 'MUI_' + iconName;
        file.extname = '.re';
        file.contents = Buffer.from(contents, 'utf-8');
        memory.moduleMuiIconsContents += 'module ' + iconName + ' = ' + 'MUI_' + iconName + ';\n';
      }
      cb(null, file);
    }))
    .pipe(dest('./src'));
}

async function makeModuleMuiIcons() {
  try {
    let contents = '/* This file generated by gulp */\n' + memory.moduleMuiIconsContents;
    await fse.outputFile('./src/MUIIcons.re', contents);
  } catch (err) {
    console.error(err);
  }
}

exports.default = series(deleteIcons, loadBaseMuiIcon, makeIcons, makeModuleMuiIcons);